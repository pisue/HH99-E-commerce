# ğŸ—‚ï¸ ì„œë¹„ìŠ¤ ë¶„ë¦¬ ë° íŠ¸ëœì­ì…˜ ì²˜ë¦¬ ë°©ì•ˆ ì„¤ê³„

---

## ëª©ì°¨

* [ê°œìš”]()
* [ì„œë¹„ìŠ¤ ë¶„ë¦¬ ì„¤ê³„ ë° íŠ¸ëœì­ì…˜ ì²˜ë¦¬ ë°©ì•ˆ]()
  + [ì„œë¹„ìŠ¤ ë¶„ë¦¬ ë° ì£¼ìš” ë‹´ë‹¹ ì—…ë¬´]()
  + [ìƒí’ˆ ì£¼ë¬¸ - ì„œë¹„ìŠ¤ ë¶„ë¦¬ ì„¤ê³„]()
* [SAGA íŒ¨í„´]()
    + [ë™ì‘ ë°©ì‹]()
    + [ì½”ë ˆì˜¤ê·¸ë˜í”¼ ê¸°ë°˜ ì‚¬ê°€ (Choreography-based Saga)]()
    + [ì˜¤ì¼€ìŠ¤íŠ¸ë ˆì´ì…˜ ê¸°ë°˜ ì‚¬ê°€ (Orchestration-based Saga)]()
* [ê²°ë¡ ]()
* [ì°¸ê³ ]()

---


## ê°œìš”
> ë¶„ì‚° ì‹œìŠ¤í…œì—ì„œ ë°ì´í„° ì¼ê´€ì„±ì„ ìœ ì§€í•˜ê¸° ìœ„í•œ íŠ¸ëœì­ì…˜ ê´€ë¦¬ ë°©ë²•ì— ëŒ€í•œ ê³ ë¯¼

## ì„œë¹„ìŠ¤ ë¶„ë¦¬ ì„¤ê³„ ë° íŠ¸ëœì­ì…˜ ì²˜ë¦¬ ë°©ì•ˆ

---

### ì„œë¹„ìŠ¤ ë¶„ë¦¬ ë° ì£¼ìš” ë‹´ë‹¹ ì—…ë¬´
- `ì£¼ë¬¸ ì„œë¹„ìŠ¤` : ì£¼ë¬¸ì˜ ìƒíƒœë¥¼ ê´€ë¦¬í•˜ê³  ì£¼ë¬¸ì •ë³´ë¥¼ ì €ì¥
- `ìƒí’ˆ ì„œë¹„ìŠ¤` : ìƒí’ˆì˜ ì •ë³´ë¥¼ ì¡°íšŒí•˜ê³  ì£¼ë¬¸ì´ ì§„í–‰ë˜ë©´ ì¬ê³ ë¥¼ ì°¨ëŒ
- `í¬ì¸íŠ¸ ì„œë¹„ìŠ¤` : ìœ ì €ì˜ í¬ì¸íŠ¸ë¥¼ ê´€ë¦¬í•˜ê³  ì£¼ë¬¸ì´ ì§„í–‰ë˜ë©´ í¬ì¸íŠ¸ë¥¼ ì°¨ê°
- `ì™¸ë¶€ í”Œë«í¼ ì„œë¹„ìŠ¤` : ì•ŒëŒ, ë©”ì¼ ë“±ì„ ì²˜ë¦¬í•¨

# Kafka ê¸°ë°˜ ì‚¬ê°€ íŒ¨í„´: ì½”ë ˆì˜¤ê·¸ë¼í”¼ ì ‘ê·¼ ë°©ì‹
ì´ ë¬¸ì„œëŠ” Kafkaë¥¼ í™œìš©í•œ ì‚¬ê°€ íŒ¨í„´ì—ì„œ ì½”ë ˆì˜¤ê·¸ë¼í”¼ ì ‘ê·¼ ë°©ì‹ì„ ì‚¬ìš©í•˜ì—¬ ì„œë¹„ìŠ¤ ê°„ ì´ë²¤íŠ¸ íë¦„ì„ ì„¤ëª…í•©ë‹ˆë‹¤. ì´ íë¦„ì€ ì „ììƒê±°ë˜ ì£¼ë¬¸ ì²˜ë¦¬ ê³¼ì •ì— ì´ˆì ì„ ë§ì¶”ê³  ìˆìŠµë‹ˆë‹¤.

## ì´ë²¤íŠ¸ íë¦„

1. **ì£¼ë¬¸ ì„œë¹„ìŠ¤ (Order Service)**:
  - Kafka í† í”½ `order-create`ì— `order-create` ì´ë²¤íŠ¸ë¥¼ ë°œí–‰í•©ë‹ˆë‹¤.
  - ì´ë²¤íŠ¸ëŠ” ì‚¬ìš©ì ID, ì£¼ë¬¸ ID, ì£¼ë¬¸ í•­ëª© ë“±ì˜ ì •ë³´ë¥¼ í¬í•¨í•©ë‹ˆë‹¤.
2. **ì¬ê³  ì„œë¹„ìŠ¤ (Stock Service)**:
  - Kafka í† í”½ `order-create`ì—ì„œ `order-create` ì´ë²¤íŠ¸ë¥¼ ìˆ˜ì‹ í•©ë‹ˆë‹¤.
  - ì´ë²¤íŠ¸ë¥¼ ì²˜ë¦¬í•˜ì—¬ ì£¼ë¬¸ëœ ìƒí’ˆì˜ ì¬ê³ ë¥¼ ì°¨ê°í•©ë‹ˆë‹¤.
  - Kafka í† í”½ `stock-decrease`ì— `stock-decrease` ì´ë²¤íŠ¸ë¥¼ ë°œí–‰í•©ë‹ˆë‹¤.
  - ì´ë²¤íŠ¸ëŠ” ìƒí’ˆ IDì™€ ê°±ì‹ ëœ ì¬ê³  ì •ë³´ë¥¼ í¬í•¨í•©ë‹ˆë‹¤.
3. **ì”ì•¡ ì„œë¹„ìŠ¤ (Balance Service)**:
  - Kafka í† í”½ `stock-decrease`ì—ì„œ `stock-decrease` ì´ë²¤íŠ¸ë¥¼ ìˆ˜ì‹ í•©ë‹ˆë‹¤.
  - ì´ë²¤íŠ¸ë¥¼ ì²˜ë¦¬í•˜ì—¬ ì‚¬ìš©ìì˜ ì”ì•¡ì—ì„œ ì´ ì£¼ë¬¸ ê¸ˆì•¡ì„ ì°¨ê°í•©ë‹ˆë‹¤.
  - Kafka í† í”½ `pay-complete`ì— `pay-complete` ì´ë²¤íŠ¸ë¥¼ ë°œí–‰í•©ë‹ˆë‹¤.
  - ì´ë²¤íŠ¸ëŠ” ì£¼ë¬¸ì˜ ìµœì¢… ìƒíƒœì™€ ì”ì•¡ ê°±ì‹  ì •ë³´ë¥¼ í¬í•¨í•©ë‹ˆë‹¤.
4. **ì£¼ë¬¸ ì„œë¹„ìŠ¤ (Order Service)**:
  - Kafka í† í”½ `order-complete`ì—ì„œ `order-complete` ì´ë²¤íŠ¸ë¥¼ ìˆ˜ì‹ í•©ë‹ˆë‹¤.
  - ë°ì´í„°ë² ì´ìŠ¤ì—ì„œ ì£¼ë¬¸ ìƒíƒœë¥¼ `complete`ë¡œ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤.

## SAGA íŒ¨í„´
- Saga Patternì€ ë§ˆì´í¬ë¡œ ì„œë¹„ìŠ¤ì—ì„œ ë°ì´í„° ì¼ê´€ì„±ì„ ê´€ë¦¬í•˜ëŠ” ë°©ë²•.
- ê° ì„œë¹„ìŠ¤ëŠ” ë¡œì»¬ íŠ¸ëœì­ì…˜ì„ ê°€ì§€ê³  ìˆìœ¼ë©°, í•´ë‹¹ ì„œë¹„ìŠ¤ ë°ì´í„°ë¥¼ ì—…ë°ì´íŠ¸í•˜ë©° ë©”ì‹œì§€ ë˜ëŠ” ì´ë²¤íŠ¸ë¥¼ ë°œí–‰í•´ì„œ, ë‹¤ìŒë‹¨ê³„ íŠ¸ëœì­ì…˜ì„ í˜¸ì¶œí•˜ê²Œ ëœë‹¤.
- ë§Œì•½, í•´ë‹¹ í”„ë¡œì„¸ìŠ¤ê°€ ì‹¤íŒ¨í•˜ê²Œ ë˜ë©´ ë°ì´í„° ì •í•©ì„±ì„ ë§ì¶”ê¸° ìœ„í•´ íŠ¸ëœì­ì…˜ì— ëŒ€í•´ ë³´ìƒ íŠ¸ëœì­ì…˜ì„ ì‹¤í–‰í•œë‹¤.
> ê°ê¸° ë‹¤ë¥¸ ë¶„ì‚° ì„œë²„ì—ì„œ ë‹¤ë¥¸ DB ë²¤ë”ì‚¬ë¥¼ ì‚¬ìš©í•˜ê³  ìˆì–´ë„, Saga Patternì„ ì‚¬ìš©í•˜ë©´ ë°ì´í„° ì¼ê´€ì„±ì„ ë³´ì¥ë°›ì„ ìˆ˜ ìˆë‹¤. ë˜í•œ íŠ¸ëœì­ì…˜ ì‹¤íŒ¨ì‹œ, ë³´ìƒ íŠ¸ëœì­ì…˜ìœ¼ë¡œ ë°ì´í„° ì •í•©ì„±ì„ ë§ì¶œ ìˆ˜ ìˆë‹¤.

### ì½”ë ˆì˜¤ê·¸ë˜í”¼ ê¸°ë°˜ ì‚¬ê°€ (Choreography-based Saga)
- ì„œë¹„ìŠ¤ ë¼ë¦¬ ì§ì ‘ì ìœ¼ë¡œ í†µì‹ í•˜ì§€ ì•Šê³ , ì´ë²¤íŠ¸ Pub/Subì„ í™œìš©í•´ì„œ í†µì‹ í•˜ëŠ” ë°©ì‹
- í”„ë¡œì„¸ìŠ¤ë¥¼ ì§„í–‰í•˜ë‹¤ê°€ ì—¬ëŸ¬ ì„œë¹„ìŠ¤ë¥¼ ê±°ì³ ì„œë¹„ìŠ¤(Stock, Payment)ì—ì„œ ì‹¤íŒ¨(ì˜ˆì™¸ì²˜ë¦¬ í˜¹ì€ ì¥ì• )ê°€ ë‚œë‹¤ë©´ ë³´ìƒ íŠ¸ëœì­ì…˜ ì´ë²¤íŠ¸ë¥¼ ë°œìƒ
- ì¥ì  : ê°„ë‹¨í•œ workflowì— ì í•©í•˜ë©° ì¶”ê°€ ì„œë¹„ìŠ¤ êµ¬í˜„ ë° ìœ ì§€ê´€ë¦¬ê°€ í•„ìš”í•˜ì§€ ì•Šì•„ ê°„ë‹¨í•˜ê²Œ ì„¸íŒ…ê°€ëŠ¥
- ë‹¨ì  : íŠ¸ëœì­ì…˜ì„ ì‹œë®¬ë ˆì´ì…˜í•˜ê¸° ìœ„í•´ ëª¨ë“  ì„œë¹„ìŠ¤ë¥¼ ì‹¤í–‰í•´ì•¼í•˜ê¸° ë•Œë¬¸ì— í†µí•©í…ŒìŠ¤íŠ¸ì™€ ë””ë²„ê¹…ì´ ì–´ë µë‹¤

### ì˜¤ì¼€ìŠ¤íŠ¸ë ˆì´ì…˜ ê¸°ë°˜ ì‚¬ê°€ (Orchestration-based Saga)
- **ì¤‘ì•ˆ ì¡°ì¥ì(Orchestrator)** ê°€ ëª¨ë“  SAGAì˜ ë‹¨ê³„ë¥¼ ê´€ë¦¬í•˜ë©°, ì´ë²¤íŠ¸ë¥¼ ë°œí–‰í•˜ê³  ê° ì„œë¹„ìŠ¤ê°€ ì´ë¥¼ ì²˜ë¦¬í•˜ë„ë¡ ìš”ì²­
- ì¤‘ì•™ ì¡°ì •ìëŠ” ê° ë‹¨ê³„ì˜ ì„±ê³µ/ì‹¤íŒ¨ ìƒíƒœë¥¼ ì¶”ì í•˜ê³ , ì‹¤íŒ¨ ì‹œ ë¡¤ë°± ì‘ì—…ì„ ì§€ì‹œ
- íŠ¸ëœì­ì…˜ ì¡°ì •ìëŠ” ê° ì„œë¹„ìŠ¤ì˜ ì‘ì—…ì„ ìˆœì„œëŒ€ë¡œ í˜¸ì¶œí•˜ê³ , ì˜¤ë¥˜ê°€ ë°œìƒí•  ê²½ìš° ë³´ìƒ íŠ¸ëœì­ì…˜ì„ ìˆ˜í–‰í•˜ë„ë¡ ì§€ì‹œ


## ê²°ë¡ 
- ì½”ë ˆì˜¤ê·¸ë˜í”¼ ê¸°ë°˜ ì‚¬ê°€ë¡œ ì§„í–‰ ì˜ˆì •
```java
ì£¼ë¬¸ì²˜ë¦¬_TX() {
  ì£¼ë¬¸_ì´ë ¥_ìƒì„±(); //init (ì£¼ë¬¸ ìƒì„± ì¤‘)
}

ì¬ê³ ì°¨ê°_TX() {
  ìƒí’ˆ_ì¬ê³ _ì¡°íšŒ();
  ìƒí’ˆ_ì¬ê³ _ì°¨ê°();
}

ì‚¬ìš©ì_ì”ì•¡_ì°¨ê°_TX {
  ì‚¬ìš©ì_ì”ì•¡_ì¡°íšŒ();
  ì‚¬ìš©ì_ì”ì•¡_ì°¨ê°();
}

ì£¼ë¬¸ì™„ë£Œì²˜ë¦¬_TX(){
  ì£¼ë¬¸_ìƒíƒœ_ë³€ê²½(); //complete
  ì£¼ë¬¸_ì•„ì´í…œ_ì €ì¥();
}

ì™¸ë¶€í”Œë«í¼_TX(){
  ì™¸ë¶€_í”Œë«í¼_ì£¼ë¬¸ì •ë³´_ì „ë‹¬();
}
```
---
```
ì£¼ë¬¸ ë²ˆí˜¸ ìƒì„± ë° ìƒíƒœ (init) -> ì£¼ë¬¸ë²ˆí˜¸ ìƒì„± ì´ë²¤íŠ¸ -> ì¬ê³  ì°¨ê° -> í¬ì¸íŠ¸ ì°¨ê° -> ì£¼ë¬¸ ìƒíƒœ ë³€ê²½(Complete)
```



- [ë¸”ë¡œê·¸](https://velog.io/@hgs-study/saga-1) ê¸€ì„ ì°¸ê³ í•˜ì—¬ Kafka ì„¤ì¹˜


## ì¹´í”„ì¹´ íŒ¨í‚¤ì§€ êµ¬ì¡°
```
- controller
- consumer
    - kafka
        - consumer
            - KafkaMessageConsumer
            - Xxx(KafkaMessage)Consumer
- application
    - service
- domain
- infra
    - kafka
        - producer
            - KafkaMessageProducer.send(Topic<T> topic, T message)
```

## ì°¸ê³ 
- [Saga íŒ¨í„´ì„ ì´ìš©í•œ ë¶„ì‚° íŠ¸ëœì­ì…˜ ì œì–´(ê²°ì œ í”„ë¡œì„¸ìŠ¤ ì‹¤ìŠµ)](https://velog.io/@hgs-study/saga-1)
- [[NHN FORWARD 22] ë¶„ì‚° ì‹œìŠ¤í…œì—ì„œ ë°ì´í„°ë¥¼ ì „ë‹¬í•˜ëŠ” íš¨ìœ¨ì ì¸ ë°©ë²•](https://www.youtube.com/watch?v=uk5fRLUsBfk&t=1416s)
